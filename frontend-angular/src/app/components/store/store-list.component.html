<div class="store-header">
  <h2>Tienda</h2>
  <p>Productos disponibles para canjear o rifar</p>
  <button *ngIf="canCreate$ | async" class="btn-primary" (click)="startCreate()">+ Nuevo producto</button>
</div>

<!-- Info de puntos del usuario -->
<div class="user-points-info" *ngIf="currentUser">
  <strong>Tus puntos disponibles:</strong>
  <span>{{ currentUser.puntos ?? 0 }} pts</span>
</div>

<!-- formulario de crear/editar -->
<div class="product-form" *ngIf="isEditing">
  <h3>{{ editingProduct?.id ? 'Editar producto' : 'Nuevo producto' }}</h3>

  <label>
    Nombre
    <input type="text" [(ngModel)]="form.nombre" name="nombre" required />
  </label>

  <label>
    Descripción
    <textarea rows="3" [(ngModel)]="form.descripcion" name="descripcion"></textarea>
  </label>

  <label>
    Precio (en puntos)
    <input type="number" step="1" [(ngModel)]="form.precio" name="precio" required />
  </label>

  <label>
    URL de imagen
    <input type="text" [(ngModel)]="form.imagenUrl" name="imagenUrl" />
  </label>

  <div class="form-actions">
    <button class="btn-primary" (click)="save()">Guardar</button>
    <button class="btn-secondary" (click)="cancel()">Cancelar</button>
  </div>
</div>

<!-- grid de productos -->
<div class="store-grid" *ngIf="products.length; else empty">
  <div class="product-card" *ngFor="let product of products">
    <div class="product-image" *ngIf="product.imagenUrl; else noImage">
      <img [src]="product.imagenUrl" [alt]="product.nombre" />
    </div>
    <ng-template #noImage>
      <div class="product-image placeholder">
        <span>Sin imagen</span>
      </div>
    </ng-template>

    <div class="product-body">
      <h3>{{ product.nombre }}</h3>
      <p>{{ product.descripcion }}</p>
      <span class="price">{{ product.precio }} pts</span>

      <!-- Acciones de admin -->
      <div class="actions">
        <button *ngIf="canEdit$ | async" class="btn-light" (click)="onEdit(product)">Editar</button>
        <button *ngIf="canDelete$ | async" class="btn-danger" (click)="onDelete(product)">Eliminar</button>
      </div>

      <!-- Acción de compra (para cualquier usuario autenticado) -->
      <div class="buy-section" *ngIf="currentUser">
        <button
          class="btn-primary"
          [disabled]="!canBuy(product) || isBuying"
          (click)="onBuy(product)">
          Canjear por {{ product.precio }} pts
        </button>

        <p *ngIf="!canBuy(product)" class="insufficient-points">
          No tienes puntos suficientes para este producto.
        </p>
      </div>
    </div>
  </div>
</div>

<ng-template #empty>
  <p>No hay productos aún.</p>
</ng-template>
